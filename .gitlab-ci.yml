image: snapcore/snapcraft:stable

stages:
  - build

before_script:
  - export LC_ALL=C.UTF-8
  - export LANG=C.UTF-8
  - export SNAP_ARCH=amd64
  - apt-get -y update
  - apt-get install -y software-properties-common openssl
  - add-apt-repository -y ppa:ubuntu-desktop/gnome-3-26
  - apt-get -y update
  - apt-get -y dist-upgrade

build-gnome-software-snap:
  stage: build
  only:
    variables:
      - $CI_COMMIT_REF_NAME == "snap-only"
  script:
    - openssl aes-256-cbc -d -in snap/.snapcraft.encrypted -out snap/.snapcraft.exported -k $KEY
    - snapcraft login --with snap/.snapcraft.exported
    - SNAPCRAFT_SETUP_CORE=1 snapcraft
    - snapcraft push gnome-software*.snap --release edge
    - snapcraft logout
    - rm -f snap/.snapcraft.exported
    - rm $HOME/.config/snapcraft/snapcraft.cfg
